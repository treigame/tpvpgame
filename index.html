<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é¬¼ã”ã£ã“ã‚²ãƒ¼ãƒ </title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s ease-out;
        }
        
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-title {
            font-size: 3em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.8;
        }
        
        .game-instructions {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 14px;
            text-align: center;
            z-index: 1001;
            border: 2px solid #00ff00;
            display: none;
            max-width: 90%;
        }
        
        .game-instructions.visible {
            display: block;
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .controls-hint {
            margin-top: 10px;
            font-size: 12px;
            opacity: 0.7;
            line-height: 1.4;
        }
        
        /* ã‚²ãƒ¼ãƒ ä¸­ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 9999;
            text-align: center;
            font-size: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
        }
        
        .success-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 255, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 9999;
            text-align: center;
            font-size: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: none;
        }
        
        /* ç”»é¢ä¸­å¤®ã®åå­— */
        .crosshair {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            z-index: 1000;
            pointer-events: none;
        }
        
        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 1px;
        }
        
        .crosshair::before {
            width: 2px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .crosshair::after {
            width: 20px;
            height: 2px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* ã‚²ãƒ¼ãƒ æƒ…å ±ãƒ‘ãƒãƒ« */
        .game-info-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #ffffff;
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 1001;
            pointer-events: none;
            min-width: 200px;
        }
        
        /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¡¨ç¤º */
        .performance-indicator {
            position: fixed;
            top: 20px;
            right: 180px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            z-index: 1001;
            pointer-events: none;
        }
        
        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ */
        @media (max-width: 768px) {
            .game-instructions {
                font-size: 12px;
                padding: 10px 15px;
                bottom: 10px;
            }
            
            #game-ui {
                font-size: 14px;
                padding: 10px;
                min-width: 150px;
            }
            
            #minimap {
                width: 120px;
                height: 120px;
            }
            
            .game-info-panel {
                bottom: 10px;
                right: 10px;
                font-size: 11px;
                min-width: 180px;
            }
        }
        
        /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .touch-control {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ï¼ãƒãƒ¼ã‚¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            100% { transform: translate(-50%, -50%) scale(1.2); }
        }
        
        /* æ¥ç¶šçŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .connection-status {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1001;
            transition: all 0.3s ease;
        }
        
        .connection-status.connected {
            background: rgba(0, 255, 0, 0.8);
            color: white;
        }
        
        .connection-status.disconnected {
            background: rgba(255, 0, 0, 0.8);
            color: white;
        }
        
        .connection-status.connecting {
            background: rgba(255, 255, 0, 0.8);
            color: black;
        }
        
        /* ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ */
        .help-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            z-index: 1001;
            transition: background-color 0.3s;
        }
        
        .help-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div id="loading-screen">
        <div class="loading-title">ğŸƒâ€â™€ï¸ 3D é¬¼ã”ã£ã“ ğŸ‘¹</div>
        <div class="loading-spinner"></div>
        <div class="loading-text">ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="loading-text" style="font-size: 0.9em;">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹</div>
    </div>

    <!-- æ¥ç¶šçŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div id="connection-status" class="connection-status connecting">æ¥ç¶šä¸­...</div>

    <!-- ç”»é¢ä¸­å¤®ã®åå­— -->
    <div class="crosshair"></div>

    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¡¨ç¤º -->
    <div id="performance-indicator" class="performance-indicator">FPS: 60</div>

    <!-- ã‚²ãƒ¼ãƒ æ“ä½œèª¬æ˜ -->
    <div id="game-instructions" class="game-instructions">
        <div><strong>ğŸ® æ“ä½œæ–¹æ³•</strong></div>
        <div><strong>WASD:</strong> ç§»å‹• | <strong>Space:</strong> ã‚¸ãƒ£ãƒ³ãƒ— | <strong>ãƒã‚¦ã‚¹:</strong> è¦–ç‚¹ç§»å‹•</div>
        <div class="controls-hint">
            <strong>ğŸ”´ èµ¤ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’8å€‹é›†ã‚ã¦é›ªç‰ã§é¬¼ã‚’å€’ãã†ï¼</strong><br>
            ğŸ‘¹ <strong>é¬¼:</strong> ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«ã‚¿ãƒƒãƒ/å‰£ã§æ”»æ’ƒã—ã¦å½¹å‰²äº¤ä»£<br>
            ğŸƒ <strong>é€ƒèµ°è€…:</strong> é¬¼ã‹ã‚‰é€ƒã’ã¦èµ¤ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’é›†ã‚ã‚‹<br>
            ğŸ§± <strong>å»ºç‰©:</strong> éš ã‚Œå ´æ‰€ã¨ã—ã¦æ´»ç”¨ã—ã‚ˆã†<br>
            âš™ï¸ <strong>Settings:</strong> å³ä¸Šã‹ã‚‰ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å¯èƒ½<br>
            â“ <strong>F1ã‚­ãƒ¼:</strong> ã“ã®èª¬æ˜ã‚’å†è¡¨ç¤º
        </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ æƒ…å ±ãƒ‘ãƒãƒ« -->
    <div id="game-info-panel" class="game-info-panel">
        <div><strong>ğŸ¯ ã‚²ãƒ¼ãƒ ç›®æ¨™</strong></div>
        <div>ãƒ»é€ƒèµ°è€…: èµ¤ã„ã‚¢ã‚¤ãƒ†ãƒ 8å€‹ã§é›ªç‰æŠ•æ“²å¯èƒ½</div>
        <div>ãƒ»é¬¼: ä»–ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¿ãƒƒãƒã—ã¦äº¤ä»£</div>
        <div>ãƒ»é›ªç‰ãŒé¬¼ã«å‘½ä¸­ã§ã‚²ãƒ¼ãƒ çµ‚äº†</div>
        <div style="margin-top: 8px; font-size: 11px; opacity: 0.7;">
            å»ºç‰©ã‚„éšœå®³ç‰©ã‚’ä½¿ã£ã¦æˆ¦ç•¥çš„ã«è¡Œå‹•ã—ã‚ˆã†
        </div>
    </div>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ -->
    <div id="help-button" class="help-button" title="ãƒ˜ãƒ«ãƒ— (F1)">?</div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ»æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div id="error-message" class="error-message"></div>
    <div id="success-message" class="success-message"></div>

    <!-- Three.js ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒãƒƒãƒ— -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.149.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.149.0/examples/jsm/"
        }
    }
    </script>

    <script>
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã®ç®¡ç†
        let gameLoaded = false;
        let userInteracted = false;
        let connectionStatus = 'connecting';

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        let lastFrameTime = performance.now();
        let frameCount = 0;
        let fps = 60;

        // æ¥ç¶šçŠ¶æ…‹ã®æ›´æ–°
        function updateConnectionStatus(status) {
            connectionStatus = status;
            const indicator = document.getElementById('connection-status');
            
            indicator.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    indicator.textContent = 'ğŸŸ¢ æ¥ç¶šæ¸ˆã¿';
                    break;
                case 'disconnected':
                    indicator.textContent = 'ğŸ”´ åˆ‡æ–­';
                    break;
                case 'connecting':
                    indicator.textContent = 'ğŸŸ¡ æ¥ç¶šä¸­...';
                    break;
            }
        }

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        function updatePerformance() {
            frameCount++;
            const currentTime = performance.now();
            
            if (currentTime - lastFrameTime >= 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastFrameTime));
                frameCount = 0;
                lastFrameTime = currentTime;
                
                const indicator = document.getElementById('performance-indicator');
                if (indicator) {
                    indicator.textContent = `FPS: ${fps}`;
                    
                    // FPSã«å¿œã˜ã¦è‰²ã‚’å¤‰æ›´
                    if (fps >= 50) {
                        indicator.style.color = '#00ff00';
                    } else if (fps >= 30) {
                        indicator.style.color = '#ffff00';
                    } else {
                        indicator.style.color = '#ff0000';
                    }
                }
                
                // ä½FPSã®è­¦å‘Š
                if (fps < 20 && gameLoaded) {
                    console.warn(`ä½FPSæ¤œå‡º: ${fps}fps - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ä¸‹ã—ã¦ã„ã¾ã™`);
                }
            }
            
            requestAnimationFrame(updatePerformance);
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¾…æ©Ÿ
        function waitForUserInteraction() {
            document.addEventListener('click', function startGame() {
                if (!userInteracted) {
                    userInteracted = true;
                    document.removeEventListener('click', startGame);
                    
                    if (gameLoaded) {
                        hideLoadingScreen();
                    } else {
                        document.querySelector('.loading-text').textContent = 'ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...';
                    }
                }
            });
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            const instructions = document.getElementById('game-instructions');
            
            loadingScreen.classList.add('hidden');
            instructions.classList.add('visible');
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
            
            // 10ç§’å¾Œã«æ“ä½œèª¬æ˜ã‚’éè¡¨ç¤º
            setTimeout(() => {
                instructions.classList.remove('visible');
            }, 10000);
        }

        // æ“ä½œèª¬æ˜ã®è¡¨ç¤º/éè¡¨ç¤º
        function toggleInstructions() {
            const instructions = document.getElementById('game-instructions');
            
            if (instructions.classList.contains('visible')) {
                instructions.classList.remove('visible');
            } else {
                instructions.classList.add('visible');
                
                // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
                setTimeout(() => {
                    instructions.classList.remove('visible');
                }, 5000);
            }
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showMessage(text, type = 'info', duration = 3000) {
            let messageElement;
            
            if (type === 'error') {
                messageElement = document.getElementById('error-message');
            } else if (type === 'success') {
                messageElement = document.getElementById('success-message');
            }
            
            if (messageElement) {
                messageElement.textContent = text;
                messageElement.style.display = 'block';
                
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, duration);
            }
        }

        // ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹é–¢æ•°
        function onGameLoaded() {
            gameLoaded = true;
            updateConnectionStatus('connected');
            
            if (userInteracted) {
                hideLoadingScreen();
            } else {
                document.querySelector('.loading-text').textContent = 'ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹';
            }
        }

        // WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function onConnectionError() {
            updateConnectionStatus('disconnected');
            showMessage('ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error', 5000);
        }

        // ã‚²ãƒ¼ãƒ çµ±è¨ˆã®è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        function showGameStats() {
            if (window.gameState) {
                console.log('=== ã‚²ãƒ¼ãƒ çµ±è¨ˆ ===');
                console.log(`ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ID: ${window.myId}`);
                console.log(`ã‚¹ã‚³ã‚¢: ${window.gameState.score}`);
                console.log(`èµ¤ã„ã‚¢ã‚¤ãƒ†ãƒ åé›†æ•°: ${window.gameState.redItemsCollected}`);
                console.log(`ã‚²ãƒ¼ãƒ æ™‚é–“: ${Math.floor((Date.now() - window.gameState.gameStartTime) / 1000)}ç§’`);
                console.log(`ç¾åœ¨ã®å½¹å‰²: ${window.myId === window.oniId ? 'é¬¼' : 'é€ƒèµ°è€…'}`);
            }
        }

        // åˆæœŸåŒ–
        waitForUserInteraction();
        updatePerformance();
        updateConnectionStatus('connecting');

        // ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‹•çš„èª­ã¿è¾¼ã¿
        window.addEventListener('load', () => {
            setTimeout(() => {
                const script = document.createElement('script');
                script.type = 'module';
                script.src = 'script.js';
                script.onload = onGameLoaded;
                script.onerror = () => {
                    showMessage('ã‚²ãƒ¼ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
                    updateConnectionStatus('disconnected');
                };
                document.body.appendChild(script);
            }, 1000); // 1ç§’ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ¼”å‡º
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        
        // ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³
        document.getElementById('help-button').addEventListener('click', toggleInstructions);

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (event) => {
            // F1ã‚­ãƒ¼ã§æ“ä½œèª¬æ˜ã‚’è¡¨ç¤º
            if (event.key === 'F1') {
                event.preventDefault();
                toggleInstructions();
            }
            
            // Escapeã‚­ãƒ¼ã§ã‚²ãƒ¼ãƒ ä¸€æ™‚åœæ­¢
            if (event.key === 'Escape') {
                if (document.pointerLockElement) {
                    document.exitPointerLock();
                }
            }

            // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
            if (event.key === 'F12' && event.ctrlKey) {
                event.preventDefault();
                showGameStats();
            }
        });

        // ãƒšãƒ¼ã‚¸ã®é›¢è„±å‰ã«è­¦å‘Š
        window.addEventListener('beforeunload', (event) => {
            if (gameLoaded && userInteracted && connectionStatus === 'connected') {
                event.preventDefault();
                event.returnValue = 'ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ';
            }
        });

        // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç®¡ç†
        let isWindowFocused = true;

        window.addEventListener('focus', () => {
            isWindowFocused = true;
            if (gameLoaded && connectionStatus === 'disconnected') {
                location.reload(); // åˆ‡æ–­ã•ã‚ŒãŸå ´åˆã¯è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
            }
        });

        window.addEventListener('blur', () => {
            isWindowFocused = false;
        });

        // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã®ç›£è¦–
        window.addEventListener('online', () => {
            if (gameLoaded && connectionStatus === 'disconnected') {
                showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒå¾©æ—§ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™...', 'success', 2000);
                setTimeout(() => location.reload(), 2000);
            }
        });

        window.addEventListener('offline', () => {
            updateConnectionStatus('disconnected');
            showMessage('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸã€‚', 'error', 5000);
        });

        // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã®æ¤œå‡º
        function isTouchDevice() {
            return (('ontouchstart' in window) ||
                   (navigator.maxTouchPoints > 0) ||
                   (navigator.msMaxTouchPoints > 0));
        }

        // ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã®å ´åˆã®åˆæœŸåŒ–
        if (isTouchDevice()) {
            document.body.classList.add('touch-device');
            
            // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’è‡ªå‹•çš„ã«æœ‰åŠ¹åŒ–ã™ã‚‹ã‹ã®ç¢ºèª
            setTimeout(() => {
                if (gameLoaded && userInteracted) {
                    const shouldEnableTabletMode = confirm('ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã‹ï¼Ÿ');
                    if (shouldEnableTabletMode && window.enableTabletMode) {
                        window.enableTabletMode();
                    }
                }
            }, 3000);
        }

        // ã‚¨ãƒ©ãƒ¼å‡¦ç†ã®æ”¹å–„
        window.addEventListener('error', (event) => {
            console.error('ã‚²ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼:', event.error);
            updateConnectionStatus('disconnected');
            showMessage('ã‚²ãƒ¼ãƒ ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚', 'error', 10000);
        });

        // æœªå‡¦ç†ã®Promiseæ‹’å¦ã‚’ã‚­ãƒ£ãƒƒãƒ
        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå‡¦ç†ã®Promiseæ‹’å¦:', event.reason);
        });

        // ã‚²ãƒ¼ãƒ å“è³ªè¨­å®šï¼ˆå°†æ¥çš„ãªæ‹¡å¼µç”¨ï¼‰
        const gameSettings = {
            graphics: 'medium', // low, medium, high
            shadows: true,
            antialiasing: true,
            maxFPS: 60
        };

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
        try {
            const savedSettings = localStorage.getItem('gameSettings');
            if (savedSettings) {
                Object.assign(gameSettings, JSON.parse(savedSettings));
            }
        } catch (e) {
            console.warn('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', e);
        }

        // è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰ä½¿ç”¨å¯èƒ½ï¼‰
        window.gameSettings = gameSettings;
    </script>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
</body>
</html>